<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pub/Sub Test Client</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div x-data="pubSubClient()" class="container mx-auto p-6 max-w-6xl">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-gray-800">Pub/Sub Test Client</h1>
          <div class="flex items-center space-x-2">
            <div class="flex items-center space-x-1">
              <div
                :class="connected ? 'bg-green-500' : 'bg-red-500'"
                class="w-3 h-3 rounded-full"
              ></div>
              <span
                class="text-sm text-gray-600"
                x-text="connected ? 'Connected' : 'Disconnected'"
              ></span>
            </div>
            <button
              @click="toggleConnection()"
              :class="connected ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'"
              class="px-4 py-2 text-white rounded-md transition-colors"
            >
              <span x-text="connected ? 'Disconnect' : 'Connect'"></span>
            </button>
          </div>
        </div>

        <!-- Connection URL -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            WebSocket URL
          </label>
          <input
            type="text"
            x-model="url"
            :disabled="connected"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
            placeholder="ws://localhost:8000/websocket"
          />
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Subscribe Section -->
          <div class="bg-blue-50 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-blue-800 mb-4">
              Subscribe to Channel
            </h2>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-blue-700 mb-1">
                  Channel ID
                </label>
                <input
                  type="text"
                  x-model="subscribeChannelId"
                  class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="channel-1"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-blue-700 mb-1">
                  Last Seen Message ID (optional)
                </label>
                <input
                  type="text"
                  x-model="lastSeenMessageId"
                  class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Leave empty for no history"
                />
              </div>
              <button
                @click="joinChannel()"
                :disabled="!connected || !subscribeChannelId.trim()"
                class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                Join Channel
              </button>
            </div>

            <!-- Active Subscriptions -->
            <div class="mt-4">
              <h3 class="text-sm font-medium text-blue-800 mb-2">
                Active Subscriptions
              </h3>
              <div class="space-y-1">
                <template x-for="channel in subscribedChannels" :key="channel">
                  <div
                    class="flex items-center justify-between bg-white p-2 rounded border"
                  >
                    <span class="text-sm text-gray-700" x-text="channel"></span>
                    <button
                      @click="leaveChannel(channel)"
                      class="text-red-500 hover:text-red-700 text-xs"
                    >
                      Leave
                    </button>
                  </div>
                </template>
                <div
                  x-show="subscribedChannels.length === 0"
                  class="text-sm text-gray-500 italic"
                >
                  No active subscriptions
                </div>
              </div>
            </div>
          </div>

          <!-- Publish Section -->
          <div class="bg-green-50 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-green-800 mb-4">
              Publish Message
            </h2>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-green-700 mb-1">
                  Channel ID
                </label>
                <input
                  type="text"
                  x-model="publishChannelId"
                  class="w-full px-3 py-2 border border-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="channel-1"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-green-700 mb-1">
                  Message
                </label>
                <textarea
                  x-model="publishMessage"
                  rows="3"
                  class="w-full px-3 py-2 border border-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="Enter your message here..."
                ></textarea>
              </div>
              <button
                @click="publishMessage()"
                :disabled="!connected || !publishChannelId.trim() || !publishMessage.trim()"
                class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                Publish Message
              </button>
            </div>
          </div>
        </div>

        <!-- Heartbeat Section -->
        <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-yellow-800">Heartbeat</h2>
            <button
              @click="sendHeartbeat()"
              :disabled="!connected"
              class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
            >
              Send Heartbeat
            </button>
          </div>
        </div>

        <!-- Message Log -->
        <div class="mt-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">Message Log</h2>
            <button
              @click="clearLog()"
              class="px-3 py-1 text-sm bg-gray-500 text-white rounded-md hover:bg-gray-600"
            >
              Clear Log
            </button>
          </div>

          <div
            class="bg-gray-50 border rounded-lg h-96 overflow-y-auto p-4"
            x-ref="logContainer"
          >
            <div
              x-show="logs.length === 0"
              class="text-gray-500 text-center py-8"
            >
              No messages yet. Connect and start testing!
            </div>

            <template x-for="(log, index) in logs" :key="index">
              <div class="mb-3 p-3 rounded-lg" :class="getLogStyle(log.type)">
                <div class="flex items-center justify-between mb-1">
                  <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium" x-text="log.type"></span>
                    <span
                      class="text-xs text-gray-500"
                      x-text="log.method || ''"
                    ></span>
                  </div>
                  <span
                    class="text-xs text-gray-500"
                    x-text="log.timestamp"
                  ></span>
                </div>
                <pre
                  class="text-sm whitespace-pre-wrap break-words"
                  x-text="log.content"
                ></pre>
              </div>
            </template>
          </div>
        </div>

        <!-- Statistics -->
        <div class="mt-6 grid grid-cols-4 gap-4 text-center">
          <div class="bg-blue-50 p-4 rounded-lg">
            <div
              class="text-xl font-bold text-blue-600"
              x-text="stats.requests"
            ></div>
            <div class="text-sm text-blue-800">Requests</div>
          </div>
          <div class="bg-green-50 p-4 rounded-lg">
            <div
              class="text-xl font-bold text-green-600"
              x-text="stats.responses"
            ></div>
            <div class="text-sm text-green-800">Responses</div>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg">
            <div
              class="text-xl font-bold text-purple-600"
              x-text="stats.notifications"
            ></div>
            <div class="text-sm text-purple-800">Notifications</div>
          </div>
          <div class="bg-red-50 p-4 rounded-lg">
            <div
              class="text-xl font-bold text-red-600"
              x-text="stats.errors"
            ></div>
            <div class="text-sm text-red-800">Errors</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function pubSubClient() {
        return {
          ws: null,
          connected: false,
          url: "ws://localhost:8000/websocket",

          // Subscribe form
          subscribeChannelId: "channel-1",
          lastSeenMessageId: "",
          subscribedChannels: [],

          // Publish form
          publishChannelId: "channel-1",
          publishMessage: "Hello, World!",

          // Logs and stats
          logs: [],
          stats: {
            requests: 0,
            responses: 0,
            notifications: 0,
            errors: 0,
          },

          // JSON-RPC ID counter
          rpcId: 1,

          toggleConnection() {
            if (this.connected) {
              this.disconnect();
            } else {
              this.connect();
            }
          },

          connect() {
            try {
              this.ws = new WebSocket(this.url);

              this.ws.onopen = () => {
                this.connected = true;
                this.addLog("SYSTEM", "Connected to WebSocket", "system");
              };

              this.ws.onmessage = (event) => {
                this.handleMessage(event.data);
              };

              this.ws.onclose = () => {
                this.connected = false;
                this.addLog("SYSTEM", "Disconnected from WebSocket", "system");
              };

              this.ws.onerror = (error) => {
                this.addLog(
                  "ERROR",
                  "WebSocket error: " + error.message,
                  "error",
                );
                this.stats.errors++;
              };
            } catch (error) {
              this.addLog(
                "ERROR",
                "Failed to connect: " + error.message,
                "error",
              );
              this.stats.errors++;
            }
          },

          disconnect() {
            if (this.ws) {
              this.ws.close();
              this.ws = null;
              this.connected = false;
              this.subscribedChannels = [];
              this.addLog("SYSTEM", "Disconnected from WebSocket", "system");
            }
          },

          handleMessage(data) {
            try {
              const message = JSON.parse(data);

              if (message.method === "notification") {
                // Handle real-time notification
                this.stats.notifications++;
                this.addLog(
                  "NOTIFICATION",
                  JSON.stringify(message.params, null, 2),
                  "notification",
                  "notification",
                );
              } else if (message.result !== undefined) {
                // Handle JSON-RPC response
                this.stats.responses++;
                this.addLog(
                  "RESPONSE",
                  JSON.stringify(message, null, 2),
                  "response",
                );
              } else if (message.error) {
                // Handle JSON-RPC error
                this.stats.errors++;
                this.addLog("ERROR", JSON.stringify(message, null, 2), "error");
              }
            } catch (error) {
              this.addLog("ERROR", "Failed to parse message: " + data, "error");
              this.stats.errors++;
            }

            this.scrollToBottom();
          },

          sendJsonRpc(method, params) {
            if (!this.connected) {
              this.addLog("ERROR", "Not connected", "error");
              return;
            }

            const request = {
              jsonrpc: "2.0",
              method: method,
              params: params,
              id: this.rpcId++,
            };

            try {
              this.ws.send(JSON.stringify(request));
              this.stats.requests++;
              this.addLog(
                "REQUEST",
                JSON.stringify(request, null, 2),
                "request",
                method,
              );
            } catch (error) {
              this.addLog(
                "ERROR",
                "Failed to send request: " + error.message,
                "error",
              );
              this.stats.errors++;
            }
          },

          joinChannel() {
            if (!this.subscribeChannelId.trim()) return;

            const params = {
              channelId: this.subscribeChannelId.trim(),
            };

            if (this.lastSeenMessageId.trim()) {
              params.lastSeenMessageId = this.lastSeenMessageId.trim();
            }

            this.sendJsonRpc("join", params);

            // Add to subscribed channels if not already there
            if (
              !this.subscribedChannels.includes(this.subscribeChannelId.trim())
            ) {
              this.subscribedChannels.push(this.subscribeChannelId.trim());
            }
          },

          publishMessage() {
            if (!this.publishChannelId.trim() || !this.publishMessage.trim())
              return;

            const params = {
              channelId: this.publishChannelId.trim(),
              payload: {
                text: this.publishMessage.trim(),
                timestamp: new Date().toISOString(),
                sender: "test-client",
              },
            };

            this.sendJsonRpc("push", params);
          },

          sendHeartbeat() {
            this.sendJsonRpc("heartbeat", {});
          },

          leaveChannel(channelId) {
            if (!this.connected) return;

            const params = {
              channelId: channelId,
            };

            this.sendJsonRpc("leave", params);

            // Remove from local list
            this.subscribedChannels = this.subscribedChannels.filter(
              (ch) => ch !== channelId,
            );
          },

          addLog(type, content, category, method = "") {
            this.logs.push({
              type: type,
              content: content,
              category: category,
              method: method,
              timestamp: this.formatTimestamp(new Date()),
            });
          },

          clearLog() {
            this.logs = [];
            this.stats = {
              requests: 0,
              responses: 0,
              notifications: 0,
              errors: 0,
            };
          },

          getLogStyle(category) {
            const styles = {
              request: "bg-blue-100 border-l-4 border-blue-500",
              response: "bg-green-100 border-l-4 border-green-500",
              notification: "bg-purple-100 border-l-4 border-purple-500",
              error: "bg-red-100 border-l-4 border-red-500",
              system: "bg-yellow-100 border-l-4 border-yellow-500",
            };
            return styles[category] || "bg-gray-100 border-l-4 border-gray-500";
          },

          formatTimestamp(date) {
            return date.toLocaleTimeString("en-US", {
              hour12: false,
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              timeZoneName: "short",
            });
          },

          scrollToBottom() {
            this.$nextTick(() => {
              const container = this.$refs.logContainer;
              container.scrollTop = container.scrollHeight;
            });
          },
        };
      }
    </script>
  </body>
</html>
